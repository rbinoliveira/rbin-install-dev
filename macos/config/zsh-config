# ===============================
# UNIVERSAL ZSH CONFIG (MAC + LINUX)
# ===============================

### -------------------------------
### COMPINIT (Completion System)
### -------------------------------
# Fix permissions for completion directories first
# This prevents the "insecure directories" warning on terminal startup
if [[ -d "$HOME/.zsh" ]]; then
  chmod 755 "$HOME/.zsh" 2>/dev/null || true
fi
if [[ -d "$HOME/.cache/zsh" ]]; then
  chmod 755 "$HOME/.cache/zsh" 2>/dev/null || true
fi
# Fix permissions for zcompdump files
if [[ -f "$HOME/.zcompdump" ]]; then
  chmod 600 "$HOME/.zcompdump" 2>/dev/null || true
fi
if [[ -f "$HOME/.zcompdump-"* ]]; then
  chmod 600 "$HOME/.zcompdump-"* 2>/dev/null || true
fi

# Load completion system
autoload -Uz compinit

# Initialize completion system
# Check if .zcompdump is older than 24 hours, if so regenerate it
# -C flag skips security check (safe since we fixed permissions above)
if [[ -n ${ZDOTDIR:-$HOME}/.zcompdump(#qN.mh+24) ]]; then
  compinit -C
else
  compinit -C
fi

# PATH default (macOS)
export PATH="$HOME/bin:$HOME/.local/bin:$PATH"

# Add Homebrew to PATH
if [[ -d "/opt/homebrew/bin" ]]; then
  export PATH="/opt/homebrew/bin:$PATH"
elif [[ -d "/usr/local/bin" ]]; then
  export PATH="/usr/local/bin:$PATH"
fi

# Detect OS (mac / linux)
case "$OSTYPE" in
  darwin*) export OS="mac";;
  linux*)  export OS="linux";;
esac

### -------------------------------
### ZINIT (Fast plugin manager)
### -------------------------------
if [[ ! -f ~/.zinit/bin/zinit.zsh ]]; then
  mkdir -p ~/.zinit
  git clone https://github.com/zdharma-continuum/zinit.git ~/.zinit/bin
fi

source ~/.zinit/bin/zinit.zsh

### -------------------------------
### PLUGINS (fast load)
### -------------------------------
zinit light zsh-users/zsh-autosuggestions
zinit light zsh-users/zsh-completions

# Syntax highlighting MUST be last
SYNTAX_PLUGIN="zsh-users/zsh-syntax-highlighting"

### -------------------------------
### ZOXIDE (smart cd)
### -------------------------------
eval "$(zoxide init zsh)"

### -------------------------------
### FZF (universal configs)
### -------------------------------
export FZF_DEFAULT_COMMAND='fd --type f'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_ALT_C_COMMAND='fd --type d'

### -------------------------------
### ALIASES
### -------------------------------
alias ls='lsd'
alias cat='bat'
alias g='git'
alias lg='lazygit'
alias c='clear'
alias reload='source ~/.zshrc'
alias tf='bash .task-flow/scripts/task-flow.sh'

### -------------------------------
### FUNCTIONS
### -------------------------------

# Open AI agents (Claude, Cursor) in 2 tabs in current directory
agents() {
  local current_dir=$(pwd)

  # Detect terminal and open tabs accordingly
  if [[ "$TERM_PROGRAM" == "iTerm.app" ]] || [[ -n "$ITERM_SESSION_ID" ]]; then
    # iTerm2
    osascript <<EOF
tell application "iTerm"
  tell current window
    # Tab 1: Claude
    create tab with default profile
    tell current session of current tab
      write text "cd '$current_dir' && echo 'ü§ñ Claude CLI' && claude"
    end tell

    # Tab 2: Cursor
    create tab with default profile
    tell current session of current tab
      write text "cd '$current_dir' && echo 'üñ•Ô∏è  Cursor CLI' && cursor-agent"
    end tell
  end tell
end tell
EOF
  elif [[ "$TERM_PROGRAM" == "Apple_Terminal" ]]; then
    # Terminal.app
    osascript <<EOF
tell application "Terminal"
  # Tab 1: Claude
  do script "cd '$current_dir' && echo 'ü§ñ Claude CLI' && claude"

  # Tab 2: Cursor
  tell application "System Events" to keystroke "t" using command down
  do script "cd '$current_dir' && echo 'üñ•Ô∏è  Cursor CLI' && cursor-agent" in front window
end tell
EOF
  else
    # Fallback: try to detect Linux terminal or use basic approach
    echo "Opening AI agents in current directory: $current_dir"

    if command -v gnome-terminal &> /dev/null; then
      # GNOME Terminal
      gnome-terminal --tab --title="Claude CLI" -- bash -c "cd '$current_dir' && echo 'ü§ñ Claude CLI' && claude; exec bash" \
                     --tab --title="Cursor CLI" -- bash -c "cd '$current_dir' && echo 'üñ•Ô∏è  Cursor CLI' && cursor-agent; exec bash"
    elif command -v konsole &> /dev/null; then
      # Konsole
      konsole --new-tab -e bash -c "cd '$current_dir' && echo 'ü§ñ Claude CLI' && claude; exec bash" \
              --new-tab -e bash -c "cd '$current_dir' && echo 'üñ•Ô∏è  Cursor CLI' && cursor-agent; exec bash"
    else
      echo "‚ö†Ô∏è  Terminal detection failed. Please open tabs manually:"
      echo "   Tab 1: cd '$current_dir' && claude"
      echo "   Tab 2: cd '$current_dir' && cursor-agent"
    fi
  fi
}

### -------------------------------
### QUALITY OF LIFE
### -------------------------------
setopt autocd
setopt interactive_comments
setopt correct

### -------------------------------
### LOAD SYNTAX HIGHLIGHTING LAST
### -------------------------------
zinit light $SYNTAX_PLUGIN

### -------------------------------
### NVM (Node Version Manager)
### -------------------------------
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

### -------------------------------
### STARSHIP (prompt)
### -------------------------------
eval "$(starship init zsh)"
