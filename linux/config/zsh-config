# ===============================
# UNIVERSAL ZSH CONFIG (MAC + LINUX)
# ===============================

### -------------------------------
### COMPINIT (Completion System)
### -------------------------------
# Fix permissions for completion directories first
# This prevents the "insecure directories" warning on terminal startup
if [[ -d "$HOME/.zsh" ]]; then
  chmod 755 "$HOME/.zsh" 2>/dev/null || true
fi
if [[ -d "$HOME/.cache/zsh" ]]; then
  chmod 755 "$HOME/.cache/zsh" 2>/dev/null || true
fi
# Fix permissions for zcompdump files
if [[ -f "$HOME/.zcompdump" ]]; then
  chmod 600 "$HOME/.zcompdump" 2>/dev/null || true
fi
if [[ -f "$HOME/.zcompdump-"* ]]; then
  chmod 600 "$HOME/.zcompdump-"* 2>/dev/null || true
fi

# Load completion system
autoload -Uz compinit

# Initialize completion system
# Check if .zcompdump is older than 24 hours, if so regenerate it
# -C flag skips security check (safe since we fixed permissions above)
if [[ -n ${ZDOTDIR:-$HOME}/.zcompdump(#qN.mh+24) ]]; then
  compinit -C
else
  compinit -C
fi

# PATH default (Linux)
export PATH="$HOME/bin:$HOME/.local/bin:$PATH"

# Add Homebrew to PATH if on macOS
if [[ "$OSTYPE" == "darwin"* ]]; then
  # Check for Apple Silicon Mac
  if [[ -d "/opt/homebrew/bin" ]]; then
    export PATH="/opt/homebrew/bin:$PATH"
  # Check for Intel Mac
  elif [[ -d "/usr/local/bin" ]]; then
    export PATH="/usr/local/bin:$PATH"
  fi
fi

# Detect OS (mac / linux)
case "$OSTYPE" in
  darwin*) export OS="mac";;
  linux*)  export OS="linux";;
esac

### -------------------------------
### ZINIT (Fast plugin manager)
### -------------------------------
if [[ ! -f ~/.zinit/bin/zinit.zsh ]]; then
  mkdir -p ~/.zinit
  git clone https://github.com/zdharma-continuum/zinit.git ~/.zinit/bin
fi

source ~/.zinit/bin/zinit.zsh

### -------------------------------
### PLUGINS (fast load)
### -------------------------------
zinit light zsh-users/zsh-autosuggestions
zinit light zsh-users/zsh-completions

# Syntax highlighting MUST be last
SYNTAX_PLUGIN="zsh-users/zsh-syntax-highlighting"

### -------------------------------
### ZOXIDE (smart cd)
### -------------------------------
# Evitar conflito: zinit usa alias "zi", e algum eval pode definir funÃ§Ã£o zi().
# Remove o alias antes do eval e restaura depois.
unalias zi 2>/dev/null
eval "$(zoxide init zsh)"
alias zi='zinit' 2>/dev/null

### -------------------------------
### FZF (universal configs)
### -------------------------------
export FZF_DEFAULT_COMMAND='fd --type f'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_ALT_C_COMMAND='fd --type d'

### -------------------------------
### ALIASES
### -------------------------------
alias ls='lsd'
# cat: usa bat (ou batcat no Debian/Ubuntu) se existir; senÃ£o cat normal
if command -v bat &>/dev/null; then
  alias cat='bat'
elif command -v batcat &>/dev/null; then
  alias cat='batcat'
fi
alias g='git'
alias lg='lazygit'
alias c='clear'
alias reload='source ~/.zshrc'
alias tf='bash .task-flow/scripts/task-flow.sh'

### -------------------------------
### FUNCTIONS
### -------------------------------

# Open AI agents (Claude, Cursor) in 2 tabs in current directory
agents() {
  local current_dir=$(pwd)

  # Detect terminal and open tabs accordingly
  if [[ "$TERM_PROGRAM" == "iTerm.app" ]] || [[ -n "$ITERM_SESSION_ID" ]]; then
    # iTerm2 (if running on macOS)
    if command -v osascript &> /dev/null; then
      osascript <<EOF
tell application "iTerm"
  tell current window
    # Tab 1: Claude
    create tab with default profile
    tell current session of current tab
      write text "cd '$current_dir' && echo 'ðŸ¤– Claude CLI' && claude"
    end tell

    # Tab 2: Cursor
    create tab with default profile
    tell current session of current tab
      write text "cd '$current_dir' && echo 'ðŸ–¥ï¸  Cursor CLI' && cursor-agent"
    end tell
  end tell
end tell
EOF
    fi
  elif [[ "$TERM_PROGRAM" == "Apple_Terminal" ]]; then
    # Terminal.app (macOS)
    if command -v osascript &> /dev/null; then
      osascript <<EOF
tell application "Terminal"
  # Tab 1: Claude
  do script "cd '$current_dir' && echo 'ðŸ¤– Claude CLI' && claude"

  # Tab 2: Cursor
  tell application "System Events" to keystroke "t" using command down
  do script "cd '$current_dir' && echo 'ðŸ–¥ï¸  Cursor CLI' && cursor-agent" in front window
end tell
EOF
    fi
  else
    # Linux terminals
    echo "Opening AI agents in current directory: $current_dir"

    if command -v gnome-terminal &> /dev/null; then
      # GNOME Terminal
      gnome-terminal --tab --title="Claude CLI" -- bash -c "cd '$current_dir' && echo 'ðŸ¤– Claude CLI' && claude; exec zsh" \
                     --tab --title="Cursor CLI" -- bash -c "cd '$current_dir' && echo 'ðŸ–¥ï¸  Cursor CLI' && cursor-agent; exec zsh"
    elif command -v konsole &> /dev/null; then
      # Konsole
      konsole --new-tab -e zsh -c "cd '$current_dir' && echo 'ðŸ¤– Claude CLI' && claude; exec zsh" \
              --new-tab -e zsh -c "cd '$current_dir' && echo 'ðŸ–¥ï¸  Cursor CLI' && cursor-agent; exec zsh"
    elif command -v xterm &> /dev/null; then
      # xterm (fallback)
      xterm -e zsh -c "cd '$current_dir' && echo 'ðŸ¤– Claude CLI' && claude; exec zsh" &
      xterm -e zsh -c "cd '$current_dir' && echo 'ðŸ–¥ï¸  Cursor CLI' && cursor-agent; exec zsh" &
    else
      echo "âš ï¸  Terminal detection failed. Please open tabs manually:"
      echo "   Tab 1: cd '$current_dir' && claude"
      echo "   Tab 2: cd '$current_dir' && cursor-agent"
    fi
  fi
}

### -------------------------------
### HISTORY (reaproveitar comandos entre sessÃµes)
### -------------------------------
HISTFILE="${XDG_DATA_HOME:-$HOME/.local/share}/zsh/history"
HISTSIZE=50000
SAVEHIST=50000
setopt EXTENDED_HISTORY          # salva timestamp no histÃ³rico
setopt SHARE_HISTORY             # compartilha histÃ³rico entre todas as sessÃµes
setopt INC_APPEND_HISTORY        # grava comando imediatamente (nÃ£o sÃ³ no exit)
setopt HIST_IGNORE_ALL_DUPS      # nÃ£o duplica linhas iguais
setopt HIST_SAVE_NO_DUPS         # ao salvar, remove duplicatas
setopt HIST_FIND_NO_DUPS         # ao buscar (seta), nÃ£o mostra duplicatas
setopt HIST_REDUCE_BLANKS        # remove espaÃ§os em branco extras
# Garante que o diretÃ³rio do histÃ³rico existe
[[ -d "${HISTFILE%/*}" ]] || mkdir -p "${HISTFILE%/*}"

### -------------------------------
### QUALITY OF LIFE
### -------------------------------
setopt autocd
setopt interactive_comments
setopt correct

### -------------------------------
### LOAD SYNTAX HIGHLIGHTING LAST
### -------------------------------
zinit light $SYNTAX_PLUGIN

### -------------------------------
### NVM (Node Version Manager)
### -------------------------------
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

### -------------------------------
### STARSHIP (prompt)
### -------------------------------
unalias zi 2>/dev/null
eval "$(starship init zsh)"
alias zi='zinit' 2>/dev/null
